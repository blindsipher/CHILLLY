<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TopstepX Test Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    pre { background: #f7f7f7; padding: 10px; white-space: pre-wrap; }
    label { display: block; margin-top: 5px; }
    input, textarea { width: 100%; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>TopstepX Test Dashboard</h1>
  <label>Base URL:
    <input id="baseUrl" value="http://localhost:8000" />
  </label>

  <section>
    <h2>WebSocket</h2>
    <label>Token:
      <input id="wsToken" />
    </label>
    <label>Patterns (comma separated):
      <input id="wsPatterns" />
    </label>
    <button onclick="connectWs()">Connect</button>
    <button onclick="disconnectWs()">Disconnect</button>
    <pre id="wsMessages"></pre>
  </section>

  <section>
    <h2>Market Data</h2>
    <button onclick="apiCall('/contracts')">GET /contracts</button>
    <div>
      <label>Contract:
        <input id="mdContract" placeholder="contract" />
      </label>
      <button onclick="apiCall('/market-data/' + get('mdContract'))">GET /market-data/{contract}</button>
      <button onclick="apiCall('/bars/' + get('mdContract'))">GET /bars/{contract}</button>
      <button onclick="apiCall('/quotes/' + get('mdContract'))">GET /quotes/{contract}</button>
    </div>
  </section>

  <section>
    <h2>Account &amp; Orders</h2>
    <button onclick="apiCall('/positions')">GET /positions</button>
    <button onclick="apiCall('/account')">GET /account</button>
    <button onclick="apiCall('/trades')">GET /trades</button>
    <button onclick="apiCall('/orders')">GET /orders</button>
    <div>
      <label>Order ID:
        <input id="orderId" placeholder="order id" />
      </label>
      <button onclick="apiCall('/orders/' + get('orderId'))">GET /orders/{order_id}</button>
    </div>
  </section>

  <section>
    <h2>Strategy</h2>
    <button onclick="apiCall('/strategies')">GET /strategies</button>
    <button onclick="apiCall('/strategies/available')">GET /strategies/available</button>
    <div>
      <label>Strategy ID:
        <input id="strategyId" placeholder="strategy id" />
      </label>
      <button onclick="apiCall('/strategies/' + get('strategyId') + '/performance')">GET /strategies/{id}/performance</button>
      <label>Config JSON:
        <textarea id="strategyConfig" rows="4" placeholder='{"key":"value"}'></textarea>
      </label>
      <button onclick="putCall('/strategies/' + get('strategyId'), get('strategyConfig'))">PUT /strategies/{id}</button>
    </div>
  </section>

  <section>
    <h2>System</h2>
    <button onclick="apiCall('/health')">GET /health</button>
    <button onclick="apiCall('/logs')">GET /logs</button>
    <button onclick="apiCall('/config')">GET /config</button>
  </section>

  <h2>Output</h2>
  <pre id="output"></pre>

  <script>
    function base() {
      return document.getElementById('baseUrl').value.replace(/\/$/, '');
    }
    function get(id) {
      return document.getElementById(id).value;
    }

    async function apiCall(path, options={}) {
      const url = base() + path;
      try {
        const res = await fetch(url, options);
        const text = await res.text();
        document.getElementById('output').textContent = res.status + ' ' + res.statusText + '\n' + text;
      } catch (err) {
        document.getElementById('output').textContent = 'Request failed: ' + err;
      }
    }

    async function putCall(path, body) {
      await apiCall(path, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: body || '{}'
      });
    }

    let ws;
    function connectWs() {
      const token = get('wsToken');
      if (!token) {
        alert('Token required');
        return;
      }
      const patterns = get('wsPatterns');
      let url = base().replace(/^http/, 'ws') + '/ws/' + encodeURIComponent(token);
      if (patterns) {
        url += '?patterns=' + encodeURIComponent(patterns);
      }
      ws = new WebSocket(url);
      ws.onmessage = (e) => {
        const pre = document.getElementById('wsMessages');
        pre.textContent += e.data + '\n';
      };
      ws.onopen = () => {
        document.getElementById('wsMessages').textContent += '[connected]\n';
      };
      ws.onclose = () => {
        document.getElementById('wsMessages').textContent += '[disconnected]\n';
      };
    }

    function disconnectWs() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }
  </script>
</body>
</html>
